# PRODUCERS AVENUE V2 - DATABASE SCHEMA

**Version:** 2.0  
**Last Updated:** November 5, 2025  
**Status:** ✅ Ready for Implementation

---

## Overview

This document outlines the complete database structure for Producers Avenue. The database uses PostgreSQL 15+ via Supabase with Row Level Security (RLS) on all tables.

**Database:** PostgreSQL 15+ (via Supabase)  
**Security:** Row Level Security (RLS) on all tables  
**Primary Keys:** UUID v4 for all tables  
**Timestamps:** All tables have `created_at` and `updated_at`

---

## Naming Conventions

- **Tables:** snake_case, plural (e.g., `user_profiles`, `products`)
- **Columns:** snake_case (e.g., `created_at`, `user_id`)
- **Foreign Keys:** `{table_singular}_id` (e.g., `user_id`, `product_id`)
- **Junction Tables:** `{table1}_{table2}` (e.g., `user_categories`)

---

## High-Level Schema Diagram

```
users (Supabase Auth - managed automatically)
  ↓
user_profiles → subscriptions → wallets
  ↓
user_categories → categories
user_skills → skills  
user_genres → genres
  ↓
followers (self-referential)
  ↓
posts → post_likes, comments
  ↓
groups → group_members, group_posts
  ↓
products, services, webinars → webinar_registrations
  ↓
orders, transactions, payouts, reviews
  ↓
conversations → messages
  ↓
notifications, articles, tags, custom_field_requests
```

---

## 1. AUTHENTICATION & USER MANAGEMENT

### users
- **Managed by Supabase Auth** (don't create this table)
- Contains: id, email, encrypted_password, email_confirmed_at
- We reference this table via `auth.users(id)`

### user_profiles
**Purpose:** Extended user information

**Key Fields:**
- user_id (FK to auth.users) - UNIQUE
- username (UNIQUE)
- display_name
- bio, avatar_url, banner_url
- **smart_link TEXT** - rolink.me URL only (validated)
- **Location fields:**
  - location_city TEXT (from IP detection or manual entry)
  - location_country TEXT
  - location_coords POINT (lat, lon) - for proximity search
  - location_source TEXT ('ip', 'gps', 'manual')
  - location_visibility TEXT ('exact', 'city', 'country', 'hidden')
  - location_last_updated TIMESTAMP
- experience_level (beginner|intermediate|professional|veteran)
- website_url
- role (member|admin|super_admin|author)
- profile_visibility (public|members_only|private)
- **is_partner_account BOOLEAN DEFAULT false** - for Ultimate for Friends
- Stats: followers_count, following_count, products_count
- Moderation: is_banned, ban_reason, banned_at, banned_by

**Smart Link Validation:**
- Must match pattern: `^https?://(www\.)?rolink\.me/.*$`
- Auto-prepend https:// if missing
- Reject any other domain
- Nullable (optional field)

**RLS:** Public read (respects visibility), users edit own

**Location Strategy:**
- All users: IP-based location (automatic, city-level)
- Paid users: Can enable GPS for precise location (via browser geolocation)
- Privacy controls: Users choose what to display

---

### categories
**Purpose:** Master list of 8 main categories

**Key Fields:**
- id UUID PRIMARY KEY
- name TEXT NOT NULL
- slug TEXT UNIQUE NOT NULL
- description TEXT
- icon TEXT (icon name or URL)
- sort_order INTEGER
- is_active BOOLEAN DEFAULT true
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**Seed Data:** Musician, Producer/Engineer, Vocalist, Visual Artist, Educator, Content Creator, Industry Professional, Music Tools Creator

**RLS:** Public read-only

---

### skills
**Purpose:** Skills under each category (100+ total)

**Key Fields:**
- id UUID PRIMARY KEY
- category_id UUID FK (categories)
- name TEXT NOT NULL
- slug TEXT UNIQUE NOT NULL
- is_active BOOLEAN DEFAULT true
- is_admin_approved BOOLEAN DEFAULT true
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**Notes:**
- Pre-seeded skills have `is_admin_approved: true`
- User-requested skills start with `is_admin_approved: false`
- Once approved, becomes visible to all users

**RLS:** Public read (only approved), admins see unapproved

---

### user_categories
**Purpose:** Many-to-many: Users → Categories

**Key Fields:**
- id UUID PRIMARY KEY
- user_id UUID FK (auth.users)
- category_id UUID FK (categories)
- created_at TIMESTAMPTZ DEFAULT NOW()
- UNIQUE (user_id, category_id)

**RLS:** Public read, users manage own

---

### user_skills
**Purpose:** Many-to-many: Users → Skills

**Key Fields:**
- id UUID PRIMARY KEY
- user_id UUID FK (auth.users)
- skill_id UUID FK (skills)
- created_at TIMESTAMPTZ DEFAULT NOW()
- UNIQUE (user_id, skill_id)

**RLS:** Public read, users manage own

---

### genres
**Purpose:** Master list of 50+ music genres

**Key Fields:**
- id UUID PRIMARY KEY
- name TEXT NOT NULL
- slug TEXT UNIQUE NOT NULL
- parent_genre_id UUID FK (genres) - for sub-genres
- is_active BOOLEAN DEFAULT true
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**RLS:** Public read-only

---

### user_genres
**Purpose:** Many-to-many: Users → Genres

**Key Fields:**
- id UUID PRIMARY KEY
- user_id UUID FK (auth.users)
- genre_id UUID FK (genres)
- created_at TIMESTAMPTZ DEFAULT NOW()
- UNIQUE (user_id, genre_id)

**RLS:** Public read, users manage own

---

### custom_field_requests
**Purpose:** Track user requests for custom skills/genres/categories

**Key Fields:**
- id UUID PRIMARY KEY
- field_type TEXT NOT NULL - 'skill' | 'genre' | 'category'
- field_value TEXT NOT NULL
- category_id UUID FK (categories) - only for skills
- requested_by UUID[] - array of user IDs who requested this
- request_count INTEGER DEFAULT 1
- status TEXT DEFAULT 'pending' - 'pending' | 'approved' | 'rejected'
- reviewed_by UUID FK (auth.users) - admin who reviewed
- reviewed_at TIMESTAMPTZ
- rejection_reason TEXT - if rejected
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()
- UNIQUE (field_type, field_value, category_id)

**Auto-Approval Logic:**
- Skills: Auto-approve when request_count >= 3
- Genres: Auto-approve when request_count >= 5
- Categories: Always manual review
- Trigger function updates status to 'auto_approved' and creates the field

**Workflow:**
1. User types custom value (e.g., "Tamburica")
2. Check if pending request exists:
   - If exists: Add user_id to requested_by array, increment request_count
   - If new: Create new pending request
3. If request_count reaches threshold: Auto-approve and create field
4. If manual approval: Admin reviews and approves/rejects
5. On approval: Create record in skills/genres/categories table
6. Notify all requesters

**RLS:** 
- Users can insert (create requests)
- Admins can read all
- Users can read only 'approved' status

---

## 2. SUBSCRIPTIONS & BILLING

### subscriptions
**Purpose:** User subscription status

**Key Fields:**
- id UUID PRIMARY KEY
- user_id UUID FK (auth.users) UNIQUE
- tier TEXT NOT NULL - 'basic' | 'standard' | 'premium' | 'ultimate'
- interval TEXT - 'monthly' | 'annual' | null (for basic)
- status TEXT - 'active' | 'cancelled' | 'past_due' | 'unpaid'
- stripe_subscription_id TEXT UNIQUE
- stripe_customer_id TEXT
- stripe_price_id TEXT
- current_period_start TIMESTAMPTZ
- current_period_end TIMESTAMPTZ
- cancel_at TIMESTAMPTZ - scheduled cancellation
- cancelled_at TIMESTAMPTZ - actual cancellation date
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**RLS:** Users view own only

**Note:** One subscription per user. Upgrades/downgrades update this record.

---

## 3. SOCIAL FEATURES

### followers
**Purpose:** Follow relationships (one-way)

**Key Fields:**
- id UUID PRIMARY KEY
- follower_id UUID FK (auth.users) - who is following
- following_id UUID FK (auth.users) - who is being followed
- created_at TIMESTAMPTZ DEFAULT NOW()
- UNIQUE (follower_id, following_id)
- CHECK (follower_id != following_id) - can't follow yourself

**Connection Detection:**
- Query both directions to check if mutual
- If both exist = "Connected" (mutual follow)
- If one way = "Following" / "Followers"

**RLS:** Public read, users can follow/unfollow

---

### posts
**Purpose:** Social feed posts

**Key Fields:**
- id UUID PRIMARY KEY
- user_id UUID FK (auth.users)
- content TEXT - rich text
- media_urls TEXT[] - array of image/video URLs
- link_url TEXT
- link_preview JSONB - {title, description, image}
- post_type TEXT - 'text' | 'image' | 'video' | 'link' | 'poll'
- poll_options JSONB - [{option: string, votes: number}]
- poll_ends_at TIMESTAMPTZ
- likes_count INTEGER DEFAULT 0
- comments_count INTEGER DEFAULT 0
- shares_count INTEGER DEFAULT 0
- is_pinned BOOLEAN DEFAULT false
- is_hidden BOOLEAN DEFAULT false
- hidden_reason TEXT
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**Indexes:** user_id, created_at DESC, full-text search on content

**RLS:** Public read (not hidden), users manage own

---

### post_likes
**Purpose:** Track who liked posts

**Key Fields:**
- id UUID PRIMARY KEY
- post_id UUID FK (posts)
- user_id UUID FK (auth.users)
- created_at TIMESTAMPTZ DEFAULT NOW()
- UNIQUE (post_id, user_id)

**Trigger:** Update posts.likes_count on INSERT/DELETE

**RLS:** Public read, users like/unlike

---

### comments
**Purpose:** Comments on posts

**Key Fields:**
- id UUID PRIMARY KEY
- post_id UUID FK (posts)
- user_id UUID FK (auth.users)
- parent_comment_id UUID FK (comments) - for nested replies
- content TEXT
- likes_count INTEGER DEFAULT 0
- is_hidden BOOLEAN DEFAULT false
- hidden_reason TEXT
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**Trigger:** Update posts.comments_count on INSERT/DELETE

**RLS:** Public read, users manage own

---

## 4. GROUPS

### groups
**Purpose:** User-created communities

**Key Fields:**
- id UUID PRIMARY KEY
- owner_id UUID FK (auth.users)
- name TEXT NOT NULL
- slug TEXT UNIQUE NOT NULL
- description TEXT
- avatar_url TEXT
- banner_url TEXT
- visibility TEXT - 'public' | 'private' | 'secret'
- join_approval_required BOOLEAN DEFAULT false
- post_approval_required BOOLEAN DEFAULT false
- rules TEXT
- tags TEXT[]
- members_count INTEGER DEFAULT 0
- posts_count INTEGER DEFAULT 0
- is_verified BOOLEAN DEFAULT false - for official/Premium+ groups
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**RLS:** Public/private viewable by all, secret only by members, owner manages

---

### group_members
**Purpose:** Group membership and roles

**Key Fields:**
- id UUID PRIMARY KEY
- group_id UUID FK (groups)
- user_id UUID FK (auth.users)
- role TEXT - 'owner' | 'admin' | 'moderator' | 'member'
- status TEXT - 'active' | 'pending' | 'banned'
- joined_at TIMESTAMPTZ
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()
- UNIQUE (group_id, user_id)

**Trigger:** Update groups.members_count on INSERT/DELETE (only active)

**RLS:** Viewable by group members

---

### group_posts
**Purpose:** Posts within groups

**Key Fields:**
- id UUID PRIMARY KEY
- group_id UUID FK (groups)
- user_id UUID FK (auth.users)
- content TEXT
- media_urls TEXT[]
- link_url TEXT
- link_preview JSONB
- post_type TEXT - same as posts
- is_pinned BOOLEAN DEFAULT false
- is_approved BOOLEAN DEFAULT true - false if approval required
- likes_count INTEGER DEFAULT 0
- comments_count INTEGER DEFAULT 0
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**Trigger:** Update groups.posts_count on INSERT/DELETE (only approved)

**RLS:** Viewable by group members only

---

## 5. MARKETPLACE

### products
**Purpose:** Digital products for sale

**Key Fields:**
- id UUID PRIMARY KEY
- seller_id UUID FK (auth.users)
- title TEXT NOT NULL
- slug TEXT UNIQUE NOT NULL
- description TEXT - rich text
- product_type TEXT - 'regular' | 'recorded_webinar'
- source_webinar_id UUID FK (webinars) - nullable, for webinar recordings
- thumbnail_url TEXT
- preview_images TEXT[] - array of image URLs
- preview_audio_url TEXT - preview/demo audio
- preview_video_url TEXT - preview/demo video
- file_urls TEXT[] - actual product files on Bunny.net
- file_size_bytes BIGINT
- file_types TEXT[] - e.g., ['wav', 'mp3', 'zip']
- price DECIMAL(10,2) - 0.00 for free
- is_free BOOLEAN DEFAULT false
- allow_name_your_price BOOLEAN DEFAULT false
- minimum_price DECIMAL(10,2) - if name your price
- technical_details JSONB - {bpm, key, sample_rate, bit_depth, etc}
- license_type TEXT - 'personal' | 'commercial' | 'exclusive' | 'custom'
- license_text TEXT - custom license terms
- category_id UUID FK (categories)
- tags TEXT[]
- genre_tags TEXT[]
- views_count INTEGER DEFAULT 0
- likes_count INTEGER DEFAULT 0
- purchases_count INTEGER DEFAULT 0
- rating_average DECIMAL(3,2) DEFAULT 0.00
- reviews_count INTEGER DEFAULT 0
- status TEXT - 'draft' | 'active' | 'paused' | 'deleted'
- is_featured BOOLEAN DEFAULT false
- featured_at TIMESTAMPTZ
- is_approved BOOLEAN DEFAULT true
- approval_notes TEXT
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**Indexes:** seller_id, slug, status, is_featured, tags, genre_tags, created_at DESC, full-text search on title+description

**RLS:** Public read (active & approved), sellers manage own

**Note:** Webinar recordings become products via conversion (not automatic)

---

### services
**Purpose:** Services offered (including mentoring)

**Key Fields:**
- id UUID PRIMARY KEY
- seller_id UUID FK (auth.users)
- title TEXT NOT NULL
- slug TEXT UNIQUE NOT NULL
- description TEXT - rich text
- service_type TEXT - 'production' | 'mixing' | 'mastering' | 'recording' | 'vocals' | 'design' | 'video' | 'consultation' | 'other'
- is_mentoring BOOLEAN DEFAULT false - flag for mentoring services
- thumbnail_url TEXT
- portfolio_urls TEXT[] - work samples
- packages JSONB - [{name, price, delivery_days, revisions, features: []}]
- buyer_requirements TEXT - what buyer needs to provide
- category_id UUID FK (categories)
- tags TEXT[]
- genre_tags TEXT[]
- views_count INTEGER DEFAULT 0
- orders_count INTEGER DEFAULT 0
- rating_average DECIMAL(3,2) DEFAULT 0.00
- reviews_count INTEGER DEFAULT 0
- response_time_hours INTEGER - average response time
- completion_rate DECIMAL(5,2) - percentage of completed orders
- status TEXT - 'draft' | 'active' | 'paused' | 'deleted'
- is_featured BOOLEAN DEFAULT false
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**Indexes:** seller_id, slug, status, is_featured, is_mentoring, tags, genre_tags, created_at DESC

**RLS:** Public read (active), sellers manage own

**Note:** Mentoring is a service with `is_mentoring: true`

---

### orders
**Purpose:** Service orders and fulfillment

**Key Fields:**
- id UUID PRIMARY KEY
- service_id UUID FK (services)
- buyer_id UUID FK (auth.users)
- seller_id UUID FK (auth.users)
- package_name TEXT - snapshot
- package_price DECIMAL(10,2) - snapshot
- delivery_days INTEGER - snapshot
- revisions_included INTEGER - snapshot
- requirements TEXT - from buyer
- requirement_files TEXT[] - files uploaded by buyer
- delivery_files TEXT[] - files delivered by seller
- delivery_notes TEXT - from seller
- delivered_at TIMESTAMPTZ
- status TEXT - 'pending' | 'in_progress' | 'delivered' | 'revision_requested' | 'completed' | 'cancelled' | 'refunded'
- revisions_used INTEGER DEFAULT 0
- buyer_approved BOOLEAN DEFAULT false
- completed_at TIMESTAMPTZ
- cancelled_at TIMESTAMPTZ
- cancellation_reason TEXT
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**Indexes:** service_id, buyer_id, seller_id, status, created_at DESC

**RLS:** Buyer and seller can view/manage

---

### webinars
**Purpose:** Live online workshops (Phase 2)

**Key Fields:**
- id UUID PRIMARY KEY
- host_id UUID FK (auth.users)
- co_hosts UUID[] - array of user IDs (Premium+)
- title TEXT NOT NULL
- slug TEXT UNIQUE NOT NULL
- description TEXT
- thumbnail_url TEXT
- cover_image_url TEXT
- scheduled_at TIMESTAMPTZ NOT NULL
- duration_minutes INTEGER
- price DECIMAL(10,2) - 0 for free
- max_attendees INTEGER - null for unlimited
- room_id TEXT - 100ms room ID
- recording_url TEXT - after webinar ends
- status TEXT - 'upcoming' | 'live' | 'ended' | 'cancelled'
- category_id UUID FK (categories)
- tags TEXT[]
- registrations_count INTEGER DEFAULT 0
- attendees_count INTEGER DEFAULT 0 - actual live count
- is_recorded BOOLEAN DEFAULT false
- recording_available BOOLEAN DEFAULT false
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**Indexes:** host_id, slug, scheduled_at, status

**RLS:** Public read (upcoming & live), hosts manage own

---

### webinar_registrations
**Purpose:** Track who registered for webinars

**Key Fields:**
- id UUID PRIMARY KEY
- webinar_id UUID FK (webinars)
- user_id UUID FK (auth.users)
- payment_status TEXT - 'pending' | 'paid' | 'refunded' | 'free'
- attended BOOLEAN DEFAULT false
- attended_at TIMESTAMPTZ
- created_at TIMESTAMPTZ DEFAULT NOW()
- UNIQUE (webinar_id, user_id)

**RLS:** Users view own, hosts view for their webinars

---

### reviews
**Purpose:** Reviews for products and services (Phase 2)

**Key Fields:**
- id UUID PRIMARY KEY
- reviewer_id UUID FK (auth.users)
- reviewable_type TEXT - 'product' | 'service' | 'webinar'
- reviewable_id UUID - polymorphic
- seller_id UUID FK (auth.users) - for filtering
- rating INTEGER CHECK (rating >= 1 AND rating <= 5)
- review_text TEXT
- seller_response TEXT
- seller_responded_at TIMESTAMPTZ
- is_verified_purchase BOOLEAN DEFAULT false
- helpful_count INTEGER DEFAULT 0
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**Indexes:** reviewable_type, reviewable_id, seller_id, reviewer_id

**RLS:** Public read, reviewer manages own, seller can respond

---

## 6. FINANCIAL

### transactions
**Purpose:** All financial transactions

**Key Fields:**
- id UUID PRIMARY KEY
- buyer_id UUID FK (auth.users)
- seller_id UUID FK (auth.users) - nullable for subscriptions
- transaction_type TEXT - 'product_purchase' | 'service_purchase' | 'webinar_registration' | 'subscription_payment' | 'payout' | 'refund'
- related_id UUID - product_id, service_id, order_id, webinar_id, subscription_id
- **Amounts (in cents):**
  - amount_total INTEGER - what buyer paid
  - amount_fees INTEGER - Stripe/PayPal processing fees (paid by seller)
  - amount_commission INTEGER - platform commission (paid by seller)
  - amount_seller INTEGER - what seller receives
- **Fee breakdown:**
  - commission_rate DECIMAL(5,2) - percentage snapshot
  - seller_tier TEXT - subscription tier at sale time
  - payment_processor TEXT - 'stripe' | 'paypal' | 'wallet'
- **Payment processor details:**
  - stripe_payment_intent_id TEXT
  - stripe_charge_id TEXT
  - paypal_transaction_id TEXT
  - paypal_order_id TEXT
- payment_method TEXT - 'card' | 'paypal' | 'wallet_balance'
- status TEXT - 'pending' | 'completed' | 'refunded' | 'failed' | 'disputed'
- completed_at TIMESTAMPTZ
- refunded_at TIMESTAMPTZ
- metadata JSONB - additional data
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**Indexes:** buyer_id, seller_id, transaction_type, status, payment processor IDs, created_at DESC

**RLS:** Users view own transactions (buyer or seller)

**Important:** All fees (processing + commission) paid by seller, buyers pay listed price

---

### wallets
**Purpose:** User wallet balances and earnings tracking

**Key Fields:**
- id UUID PRIMARY KEY
- user_id UUID FK (auth.users) UNIQUE
- balance_available INTEGER DEFAULT 0 - cents, ready to withdraw
- balance_pending INTEGER DEFAULT 0 - cents, in escrow (7-day hold)
- **Earnings tracking:**
  - total_earned_stripe INTEGER DEFAULT 0 - all-time Stripe earnings (cents)
  - total_earned_paypal INTEGER DEFAULT 0 - all-time PayPal earnings (cents)
  - total_earned INTEGER DEFAULT 0 - combined total (cents)
- **Withdrawal tracking:**
  - total_withdrawn_stripe INTEGER DEFAULT 0 - (cents)
  - total_withdrawn_paypal INTEGER DEFAULT 0 - (cents)
  - total_withdrawn INTEGER DEFAULT 0 - combined total (cents)
- total_spent_on_platform INTEGER DEFAULT 0 - purchases using wallet (cents)
- **Payout methods:**
  - stripe_account_id TEXT - Stripe Connect account
  - stripe_account_status TEXT - 'enabled' | 'pending' | 'disabled'
  - paypal_email TEXT - for PayPal payouts
  - paypal_verified BOOLEAN DEFAULT false
- payouts_enabled BOOLEAN DEFAULT false
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**RLS:** Users view own wallet only

**Minimum Withdrawal:** $50 (5000 cents)

---

### payouts
**Purpose:** Withdrawal requests

**Key Fields:**
- id UUID PRIMARY KEY
- user_id UUID FK (auth.users)
- wallet_id UUID FK (wallets)
- amount INTEGER NOT NULL - cents, minimum $50 = 5000 cents
- payout_method TEXT - 'stripe' | 'paypal'
- stripe_payout_id TEXT
- paypal_batch_id TEXT
- status TEXT - 'pending' | 'processing' | 'completed' | 'failed' | 'cancelled'
- requested_at TIMESTAMPTZ DEFAULT NOW()
- approved_at TIMESTAMPTZ
- approved_by UUID FK (auth.users) - admin
- completed_at TIMESTAMPTZ
- failed_at TIMESTAMPTZ
- failure_reason TEXT
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**Indexes:** user_id, status, requested_at DESC

**RLS:** Users view own payouts

---

## 7. MESSAGING

### conversations
**Purpose:** Direct message conversations

**Key Fields:**
- id UUID PRIMARY KEY
- participant_ids UUID[] - array of user IDs (2 for DM, more for group)
- last_message_at TIMESTAMPTZ
- last_message_preview TEXT - first 100 chars
- is_group BOOLEAN DEFAULT false
- group_name TEXT - if group chat
- group_avatar_url TEXT - if group chat
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**Indexes:** participant_ids (GIN index), last_message_at DESC

**RLS:** Only participants can view

---

### messages
**Purpose:** Individual messages

**Key Fields:**
- id UUID PRIMARY KEY
- conversation_id UUID FK (conversations)
- sender_id UUID FK (auth.users)
- content TEXT
- attachment_urls TEXT[] - images, files
- is_read BOOLEAN DEFAULT false
- read_at TIMESTAMPTZ
- is_deleted BOOLEAN DEFAULT false
- deleted_for UUID[] - user IDs who deleted
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**Indexes:** conversation_id, sender_id, created_at ASC

**RLS:** Only conversation participants can view

---

## 8. NOTIFICATIONS

### notifications
**Purpose:** In-app notifications

**Key Fields:**
- id UUID PRIMARY KEY
- user_id UUID FK (auth.users) - recipient
- type TEXT - 'like' | 'comment' | 'follow' | 'message' | 'order' | 'payout' | 'mention' | 'review' | etc
- title TEXT
- message TEXT
- link_url TEXT - where notification leads
- actor_id UUID FK (auth.users) - who triggered it
- related_id UUID - polymorphic (post_id, order_id, etc)
- is_read BOOLEAN DEFAULT false
- read_at TIMESTAMPTZ
- created_at TIMESTAMPTZ DEFAULT NOW()

**Indexes:** user_id, is_read, created_at DESC

**RLS:** Users view own only

---

## 9. CONTENT & ADMIN

### articles
**Purpose:** Platform news and tutorials (Phase 2)

**Key Fields:**
- id UUID PRIMARY KEY
- author_id UUID FK (auth.users) - must have 'author' role
- title TEXT NOT NULL
- slug TEXT UNIQUE NOT NULL
- content TEXT - rich text
- excerpt TEXT
- thumbnail_url TEXT
- category TEXT
- tags TEXT[]
- views_count INTEGER DEFAULT 0
- likes_count INTEGER DEFAULT 0
- comments_count INTEGER DEFAULT 0
- is_published BOOLEAN DEFAULT false
- published_at TIMESTAMPTZ
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**Indexes:** author_id, slug, is_published, published_at DESC

**RLS:** Public read (published only), authors manage own

---

### report_abuse_tracking
**Purpose:** Track false reports

**Key Fields:**
- id UUID PRIMARY KEY
- user_id UUID FK (auth.users) UNIQUE
- false_report_count INTEGER DEFAULT 0
- is_report_banned BOOLEAN DEFAULT false
- report_ban_until TIMESTAMPTZ
- permanent_ban BOOLEAN DEFAULT false
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**Logic:**
- 3 false reports = 30-day report ban
- 5 false reports = permanent report ban
- Email notification each time
- Admins can override

**RLS:** Users view own, admins view all

---

## 10. TAGS (GLOBAL)

### tags
**Purpose:** Track popular tags across platform

**Key Fields:**
- id UUID PRIMARY KEY
- name TEXT NOT NULL
- slug TEXT UNIQUE NOT NULL
- usage_count INTEGER DEFAULT 0
- trending_score DECIMAL(10,2) DEFAULT 0.00
- created_at TIMESTAMPTZ DEFAULT NOW()
- updated_at TIMESTAMPTZ DEFAULT NOW()

**Note:** Tags in posts/products/services are stored as TEXT[] arrays. This table tracks aggregate stats.

**Indexes:** slug, usage_count DESC, trending_score DESC

**RLS:** Public read-only

---

## KEY RELATIONSHIPS

### Users
- user → user_profiles (1:1)
- user → subscriptions (1:1)
- user → wallets (1:1)
- user → categories (many-to-many via user_categories)
- user → skills (many-to-many via user_skills)
- user → genres (many-to-many via user_genres)
- user → user (followers - many-to-many self-referential)

### Social
- user → posts (1:many)
- post → likes (many-to-many via post_likes)
- post → comments (1:many)
- comment → comment (self-referential for replies)

### Groups
- user → groups owned (1:many)
- user → groups joined (many-to-many via group_members)
- group → posts (1:many)

### Marketplace
- user → products (1:many as seller)
- user → services (1:many as seller)
- user → webinars (1:many as host)
- webinar → product (1:1 via source_webinar_id) **← HYBRID**
- service → orders (1:many)
- order → transaction (1:1)
- product/service → reviews (1:many)

### Messaging
- user → conversations (many-to-many)
- conversation → messages (1:many)

### Financial
- user → wallet (1:1)
- wallet → transactions (1:many)
- wallet → payouts (1:many)
- transaction → payment processor (stripe or paypal)

---

## DESIGN DECISIONS & NOTES

### 1. Smart Link Only (rolink.me)
- **Single `smart_link` field** instead of multiple social_links
- Strategic partnership with Release Organizer
- Users add all platforms to their rolink.me Smart Link
- Clean profile design
- Cross-platform promotion
- Validation: Only rolink.me URLs accepted

### 2. Following/Connections Hybrid
- Single `followers` table (one-way relationships)
- Query both directions to detect mutual follows
- Display "Following/Followers" for one-way
- Display "Connected" badge for mutual
- LinkedIn-like feel when connected
- Simple database structure

### 3. Custom Field Requests
- New table: `custom_field_requests`
- User-submitted skills/genres stored as pending
- Invisible to user until approved
- Auto-approve when threshold reached (3 users for skills, 5 for genres)
- Manual approval for categories
- Admins review in panel
- All requesters notified on approval

### 4. Mentoring
- Mentoring is a type of service (`is_mentoring=true` flag)
- Backend: Uses services table
- Frontend: Dedicated "Find a Mentor" section with special UI
- Same order/booking flow as services

### 5. Featured Products
- `is_featured` boolean on products table
- Tier limits enforced in application logic:
  - Basic: 0 featured
  - Standard: 1 featured
  - Premium: 3 featured
  - Ultimate: 10 featured
  - Ultimate for Friends: 10 featured
- When user downgrades, excess featured products stay featured until user changes (grandfather clause)

### 6. Commission Calculation
- Stored in transactions table (snapshot at time of purchase)
- Commission rate based on seller's tier at purchase time
- If seller upgrades later, past transactions unchanged (fair)

### 7. Denormalized Stats
- Counts (likes_count, followers_count, etc.) stored directly on parent records
- Updated via database triggers (faster than counting on every query)
- Trade-off: Slightly more complex writes, much faster reads

### 8. All Fees Paid By Sellers
- Stripe fees: 2.9% + $0.30
- PayPal fees: ~3.49% + $0.49
- Platform commission: 10-40% (based on tier)
- Buyers always pay listed price only

### 9. RLS (Row Level Security)
- Every table has RLS policies
- Users can only see/edit their own data
- Public content visible to all
- Admins have elevated permissions (via role check)

---

## DATABASE FUNCTIONS & TRIGGERS (To Be Implemented)

### Automatic Timestamps
- Trigger: Update `updated_at` on every UPDATE

### Stats Updates
- Trigger: Update follower counts when followers added/removed
- Trigger: Update likes_count when post_likes added/removed
- Trigger: Update members_count when group_members added/removed
- Trigger: Update purchases_count when product purchased
- etc.

### Auto-Create on User Signup
- Trigger: When user signs up (auth.users INSERT), automatically create:
  - user_profiles record
  - subscriptions record (tier='basic')
  - wallets record

### Auto-Approval for Custom Fields
- Trigger: When custom_field_requests.request_count reaches threshold:
  - Update status to 'auto_approved'
  - Create record in skills/genres table
  - Notify all requesters

---

## INDEXES STRATEGY

**High Priority (Create Immediately):**
- Foreign keys (all FK columns) - automatic
- Lookup fields (username, slug, email)
- Filter fields (status, visibility, is_featured)
- Sort fields (created_at DESC)
- Full-text search (posts.content, products.title+description, articles.content)

**Medium Priority (Add as Needed):**
- JSONB fields (GIN indexes)
- Array fields (GIN indexes for tags, genre_tags)
- Geographic (GIST for location_coords)

**Monitor Performance:**
- Add indexes based on slow query logs
- Use EXPLAIN ANALYZE to optimize

---

## ESTIMATED TABLE COUNT

**Total:** 35+ tables

**Breakdown:**
- Users & Auth: 8 tables
- Subscriptions: 1 table
- Social: 5 tables  
- Groups: 3 tables
- Marketplace: 6 tables
- Financial: 4 tables
- Messaging: 2 tables
- Notifications: 1 table
- Content: 2 tables
- Other: 3 tables

---

## NEXT STEPS (During Development)

1. **Set up Supabase project**
2. **Create tables in order:**
   - Start with users/profiles (with smart_link field)
   - Add categories/skills/genres (seed data)
   - Add custom_field_requests table
   - Add social features (followers with hybrid logic)
   - Add marketplace
   - Add financial
3. **Implement RLS policies** (critical for security)
4. **Create triggers** (for stats updates, auto-timestamps, auto-approval)
5. **Seed master data** (categories, skills, genres)
6. **Test with dummy data**
7. **Optimize indexes** (based on query patterns)
8. **Implement custom field request workflow**
9. **Test smart_link validation**

---

**Document Version:** 2.0  
**Last Updated:** November 5, 2025  
**Status:** ✅ Ready for Implementation - Corrected with smart_link field